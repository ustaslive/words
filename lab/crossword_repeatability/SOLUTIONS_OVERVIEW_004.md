# Solution 004: Seed Selection with Static Offline Word Statistics

## Status
Draft. This document captures initial theses and will be expanded incrementally.

## 1) Core idea
- This is a fourth seed-selection mode.
- Seed is generated as a **set of letters**, not as a long dictionary word.

## 2) Offline statistics file for this mode
- Along with main dictionaries, the app ships an additional file (working name: `004.txt`).
- `004.txt` is generated by a lab script that simulates seed-selection logic used by the app.
- The file contains per-word statistics for dictionary words.

## 3) How crossword words use `004.txt`
- Crosswords are built from allowed dictionary words with forbidden words excluded.
- When needed, crossword words are matched against stats from `004.txt`.
- If a word is missing in `004.txt`, its stat value is treated as `0`.

## 4) Ownership and update rules for all `004*` files
- `004.txt`, `004.letters.txt`, and `004.meta.json` are read-only for the Android app.
- The app never edits any `004*` file locally.
- `004*` files change only via content updates.
- `004*` files can be delivered with a new app version.
- `004*` files can also be delivered through the same dictionary update flow in `Settings -> Update Dictionary`.

## 5) Letter-exclusion step before seed selection
- One optional pre-step before choosing a seed letter set: exclude 1, 2, or 3 frequent letters for the current round.
- The number of excluded letters (1/2/3) may be random.
- Exclusion probability for each letter is based on global letter frequency across dictionaries.
- This frequency data comes from another offline file (working name: `004.letters.txt`).
- `004.letters.txt` is also produced by lab tooling.

## 6) Version control and GitHub CI integration
- `004` artifacts should include a metadata file (working name: `004.meta.json`).
- `004.meta.json` stores input fingerprints for `words.txt`, `forbidden_words.txt`, generator script, and generator parameters/version.
- `004.meta.json` stores output fingerprints for `004.txt` and `004.letters.txt`.
- No cryptographic signature is required for this project scope.

GitHub CI flow:
1. Trigger when `words.txt`, `forbidden_words.txt`, or generator files change.
2. Run generator in CI and rebuild `004.txt`, `004.letters.txt`, and `004.meta.json`.
3. Compare generated outputs with repository files.
4. If mismatched, fail the job with a clear message to regenerate and commit `004*`.
5. Optional later step: add a bot PR mode that commits regenerated `004*` automatically.

## 7) File formats
`004.txt` format:
- One entry per line: `<word>:<count>`.
- `word` uses the same normalization as `words.txt` (currently lowercase alphabetic token).
- `count` is non-negative integer.
- If duplicate words appear, the last line wins (generator should avoid duplicates).

`004.letters.txt` format:
- One entry per line: `<letter>:<count>`.
- `letter` uses the same normalization as dictionary letters (currently one lowercase character).
- `count` is non-negative integer.
- If duplicate letters appear, the last line wins (generator should avoid duplicates).

`004.meta.json` format:
- UTF-8 JSON object.
- Required top-level fields:
- `format` (string, example: `v1`);
- `generated_at_utc` (ISO-8601 UTC string);
- `generator` (object with script/version info);
- `inputs` (object with input file hashes);
- `outputs` (object with output file hashes).
- Hash algorithm: `sha256`.

Comments and ignored lines:
- A line that starts with `#` is a comment and must be ignored by parser.
- Empty lines must be ignored by parser.
- Inline comments are not supported to keep parsing simple.
- Comment rules above apply to `004.txt` and `004.letters.txt` only.
- `004.meta.json` must be valid JSON and does not support comments.

Examples:
```text
# format=v1
# source=lab
apple:123
note:97
```

```text
# format=v1
a:18452
e:21301
```

```json
{
  "format": "v1",
  "generated_at_utc": "2026-02-15T21:10:00Z",
  "generator": {
    "script": "lab/crossword_repeatability/generate_004.py",
    "version": "1.0.0"
  },
  "inputs": {
    "words_txt_sha256": "4c6c3c2a...f8b1",
    "forbidden_words_txt_sha256": "a91f0d5e...2d44",
    "generator_script_sha256": "f31b8f7a...8aa0",
    "generator_params_sha256": "6b2c93aa...93de"
  },
  "outputs": {
    "004_txt_sha256": "71de9f3a...112c",
    "004_letters_txt_sha256": "f2b5d314...9b70"
  }
}
```

## 8) Draft generation algorithm (unfinished)
This section captures the current draft flow and is intentionally incomplete.

Initial state:
- Keep `previousSeed` and `previousWordSet` in memory only.
- Both can be empty after app restart (no disk persistence for this state).

Main loop (`attempt` from `1` to configured max attempts):
1. Randomly choose `excludeCount` in range `1..3`.
2. From letters of `previousSeed`, select letters to exclude using `004.letters.txt` frequency (prefer higher-frequency letters first).
3. Build full alphabet and remove excluded letters.
4. Generate a new seed letter set from the reduced alphabet, with length from current configuration.
5. Build mini-dictionary for this seed:
- collect all words buildable from seed;
- keep only words with length `>= MIN_CROSSWORD_WORD_LENGTH`.
6. Build a crossword layout from that mini-dictionary.
7. Validate by layout result (not by raw buildable list only):
- reject seed if `layout.words.size < MIN_CROSSWORD_WORD_COUNT`.
8. Reject seed if at least one word from `layout.words` overlaps with `previousWordSet`.
9. Apply mode-specific extra validation:
- for letter-generated modes, require all seed letters to be used in layout words (`areAllSeedLettersUsed` behavior).
10. Apply structural layout validation constraints:
- placement rules from current crossword generator;
- max layout bounds `<= 14 x 14`;
- reject layout if constraints are violated.
11. If seed is rejected, add it to rejected list and log rejection reason:
- always track rejected seed values;
- for low-word-count case, log a specific diagnostics entry.
12. If seed passed checks, store candidate as `(seed, wordSet)`.
13. If no best candidate exists yet, mark current candidate as best.
14. If best candidate already exists, compare current vs best by criteria (to be defined) and keep only one as best.
15. Continue loop until max attempts is reached, always comparing with current best candidate.

After loop:
1. Best candidate becomes the finalist `(seed, wordSet)`.
2. Build crossword dictionary/input from finalist.
3. If no finalist was found:
- set generation error state;
- keep existing crossword/grid if one already exists;
- only clear state when there is no previous grid to keep.

State update rules:
- If player completes the crossword, finalist `(seed, wordSet)` becomes `previousSeed` and `previousWordSet` for the next game.
- If player presses reset/rebuild, restart flow from step 1 of main loop (new random `excludeCount`).

Auto-regeneration trigger:
- when dictionary/eligible seed pool changes and current seed becomes ineligible, trigger a new generation cycle automatically.

## 9) Explicit step matrix by mode
To keep logic explicit and easy to mirror in both Kotlin and Python, each mode uses the same fixed step slots.

Fixed step slots:
1. `step_build_layout`
2. `step_min_word_count`
3. `step_no_overlap_previous`
4. `step_mode_extra_a`
5. `step_mode_extra_b`

Mode-to-steps mapping:
- `m1 = [step_build_layout, step_min_word_count, step_no_overlap_previous, none, none]`
- `m2 = [step_build_layout, step_min_word_count, step_no_overlap_previous, step_mode2_extra, none]`
- `m3 = [step_build_layout, step_min_word_count, step_no_overlap_previous, step_all_seed_letters_used, none]`
- `m4 = [step_build_layout, step_min_word_count, step_no_overlap_previous, none, step_use_004_stats]`

Rules:
- `none`/`null` means the slot is intentionally skipped for that mode.
- Runner executes slots strictly in order from 1 to 5.
- Any failed step rejects the seed immediately with a reason.
- No hidden branching should decide whether a step is active; activation is defined only by the matrix above.

Implementation note:
- Python: `dict[mode] -> list[callable | None]`
- Kotlin: `Map<Mode, List<Step?>>`
- Keep slot names identical in both languages for easier logic sync.

## 10) Open points to define next
- How stats from `004.txt` influence ranking of candidate seed letter sets.
- Exact randomization policy for excluding 1/2/3 letters.
- Exact comparison criteria for candidate-vs-best selection in the loop.
- Fallback behavior when update files are missing, stale, or partially incompatible.
